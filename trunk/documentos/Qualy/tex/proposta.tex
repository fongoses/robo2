%==========================================================
% SCE=567 Projeto Supervisionado ou de Graduacao II
% 
% Capitulo 3: Estado Atual do Trabalho.
% 
% Autor
% Heitor Luis Polidoro
% 
% Orientador
% Prof. Dr. Denis Fernando Wolf
%==========================================================

\chapter{Estado Atual do Trabalho}
\label{estado_atual_trabalho}

\section{Projeto}
\label{projeto}
A proposta desse projeto é a elaboração, implementação, validação e comparação de algoritmos de definição de áreas a serem visitadas em ambientes internos utilizando algoritmos de busca de trajetórias e desvio de obstáculos, objetivando o monitoramento desse ambiente. 

\section{Descrição das Atividades Realizadas}
\label{descricao_atividades_realizadas}
Nesta seção está detalhado todas as atividades realizadas para a conclusão do projeto: Controle do Robô (\ref{estudo_player/stage}), Desvio de Obstáculos (\ref{estudo_e_implementacao_campos_potenciais}), Planejamento de trajetória (\ref{estudo_e_implementacao_planejamento_trajetoria}), Determinação da seqüência de áreas (\ref{desenvolvimento_e_implementacao_determinacao_areas}) e Integração e validação dos algoritmos (\ref{integracao_e_validacao_algoritmos_stage})
\subsection{Estudo do Ambiente de Controle de Robôs Móveis Player/Stage}
\label{estudo_player/stage}
Apesar do contato anterior com o Player/Stage nas disciplinas \textit{``Projeto e Implementação de Sistemas Embarcados I''} e \textit{``II''}, foi necessário um novo estudo, pois o Player/Stage foi adaptado pelo Prof. Dr. Denis Fernando Wolf para facilitar a adaptação dos alunos com o Player/Stage nas disciplinas.

\subsection{Estudo e Implementação do Algoritmo de Desvio de Obstáculos}
\label{estudo_e_implementacao_campos_potenciais}
Existem vários algoritmos para desvio de obstáculos: Desvio Tangencial, desvio utilizando-se Redes Neurais Artificiais, Campos Potenciais, etc. O algoritmo escolhido para o projeto foi o de Campos Potenciais, por ser de fácil implementação e ter um resultado satisfatório.
O algoritmo de campos potenciais foi implementado da seguinte forma:
\begin{itemize}
	\item É feita a leitura de 9 LASERs do robô: 0º, 30º, 60º, 75º, 90º, 105º, 120º, 150º e 180º (Figura \ref{fig:laser});
	\item Foi estabelecido um valor (\texttt{MAX\_DIST}) que se a distância do robô ao obstáculo foi superior que o mesmo, não há necessidade de desvio;
	\item Calcula-se a diferença entre a leitura do LASER (distância para o obstáculo) e \texttt{MAX\_DIST} (somente se a leitura do LASER for menor que \texttt{MAX\_DIST});
	\[dif_i = \texttt{MAX\_DIST} - [leitura\_do\_laser\_i]\]
 	\item Para os ângulos maiores que 180º a diferença é multiplicada por -1;
	\item Somam-se todas as diferenças;
	\[CP = \sum dif_i\]

\end{itemize}
 
\figura{Imagens/laser.jpg}{1}{LASERs Utilizados para Desvio de Obstáculos}{fig:laser}

Com isso, se obtém um valor que é proporcional à velocidade com que o robô deve virar ($|CP|$) e para qual lado ($sign(CP)$  positivo vira para a direita, negativo vira para a esquerda).

\subsection{Estudo e Implementação dos Algoritmos de Planejamento de Trajetória}
\label{estudo_e_implementacao_planejamento_trajetoria}
Foi utilizado um algoritmo de planejamento de trajetória chamado \textit{Ants}. Veja a seguir o algoritmo \ref{alg:ants} e o fluxograma (Figura \ref{fig:fluxograma_ants}) desse algoritmo.

\begin{algorithm}
\caption{Algoritmo Ants}
\label{alg:ants}
\begin{algorithmic}[1]
	\STATE Cria um agente e coloca na fila
	\STATE $minimo\_encontrado \Leftarrow \infty$
	\WHILE{Existir Agente na Fila}
		\STATE Retira o Agente da Fila
		\FOR{Cada nó adjacente não visitado ao nó do Agente}
			\STATE Cria uma cópia do Agente
			\STATE ``Anda'' com o Agente para o nó
			\STATE Armazena o caminho
			\STATE Soma o peso
			\IF{$soma < minimo\_encontrado$}
				\IF{Novo nó = Destino}
					\STATE $minimo\_encontrado \Leftarrow soma$
					\STATE Guarda/Substitui o Agente que encontrou o menor caminho
				\ELSE
					\STATE Insere o Agente na fila
				\ENDIF
			\ENDIF
		\ENDFOR
	\ENDWHILE
\end{algorithmic}
\end{algorithm}

\figura{Imagens/fluxograma_ants.jpg}{.70}{Fluxograma do Algoritmo Ants}{fig:fluxograma_ants}

A intensão de usar esse algoritmo é que ele é facilmente paralelizável, basta cada processo retirar e analisar um agente da fila, aumentando a velocidade de resposta do algoritmo.

\subsection{Desenvolvimento e Implementação dos Algoritmos de Determinação das Áreas que Devem Ser Visitadas}
\label{desenvolvimento_e_implementacao_determinacao_areas}
Foram criados dois ambientes virtuais, um com baixa conectividade, mais perto da realidade (Mapa 1 - Figura \ref{fig:mapa_rep}) e outro com alta conectividade (Mapa 2 - Figura \ref{fig:mapa_andar}) para testar os algoritmos de planejamento de trajetória. Como o algoritmo de campos potencias fatalmente cairá no problema de mínimos locais, foram criados pontos de interseção para evitar esse problema, e os círculos numerados são as salas. A posição dos pontos e das salas foram criados pelo autor, da forma que achou conveniente, sem seguir um padrão ou regra específica. As prioridades das áreas foram escolhidas de forma arbitrária e estão descritas nas tabelas, Tabela \ref{tab:prioridade_rep}, Tabela \ref{tab:prioridade_andar}. As salas inicias escolhidas foram, Sala 5 e Sala 10, para os mapas 1 e 2, respectivamente.

\figura{Imagens/mapa_rep.jpg}{.75}{Mapa 1.}{fig:mapa_rep}

\begin{table}
\begin{center}
	\begin{tabular}{|c|c|c|}
	\hline
	Sala & Prioridade\\
	\hline
	1 & 9\\
	\hline
	2 & 2\\
	\hline
	3 & 9\\
	\hline
	4 & 4\\
	\hline
	5 & 9\\
	\hline
	6 & 6\\
	\hline
	7 & 2\\
	\hline
	8 & 9\\
	\hline
	9 & 6\\
	\hline
	10 & 7\\
	\hline
	11 & 1\\
	\hline
	12 & 2\\
	\hline
	13 & 4\\
	\hline
	\end{tabular}
\caption{Prioridades do Mapa 1}
\label{tab:prioridade_rep}
\end{center}
\end{table}

\figura{Imagens/mapa_andar.jpg}{.75}{Mapa 2}{fig:mapa_andar}

\begin{table}
\begin{center}
	\begin{tabular}{|c|c|c}
	\hline
	Sala & Prioridade\\
	\hline
	1 & 2\\
	\hline
	2 & 1\\
	\hline
	3 & 2\\
	\hline
	4 & 1\\
	\hline
	5 & 1\\
	\hline
	6 & 1\\
	\hline
	7 & 2\\
	\hline
	8 & 1\\
	\hline
	9 & 2\\
	\hline
	10 & 3\\
	\hline
	\end{tabular}
\caption{Prioridades do Mapa 2}
\label{tab:prioridade_andar}
\end{center}
\end{table}

Para auxiliar as decisões, foi criado um grau de urgência de visita $U$ para cada sala, esse grau de urgência é calculado multiplicando-se a prioridade da sala $P$ pelo tempo decorrido desde a última visita $t$. A casa visita o $t$ é zerado.
\[U = P \times t\]
Foram desenvolvidos três algoritmos. O algoritmo 1 (\ref{alg:1}) verifica qual sala que possui o maior grau de urgência e manda o robô visitar aquela sala. O algoritmo 2 (\ref{alg:2}) manda o robô visitar a sala que possui o maior grau de urgência visitando as salas que são adjacentes à algum vértice da trajetória até a sala destino. Finalmente, o algoritmo 3 (\ref{alg:3}) calcula um fator para cada sala, e manda o robô visitar a sala com maior fator. Esse fator é calculado dividindo o grau de urgência da sala pelo custo para chegar até a sala.
\[Fator = [Grau\_de\_Urgencia] / [custo]\]

\begin{algorithm}
\caption{Algoritmo 1}
\label{alg:1}
\begin{algorithmic}[1]
	\STATE $sala \Leftarrow sala\_inicial$
	\LOOP
		\STATE Visita sala atual //Zera o $t$ da sala atual na tabela
		\STATE $sala \Leftarrow$ sala\_de\_maior\_grau\_de\_urgência()
		\STATE Vai para $sala$
	\ENDLOOP
\end{algorithmic}
\end{algorithm}

\begin{algorithm}
\caption{Algoritmo 2}
\label{alg:2}
\begin{algorithmic}[1]
	\STATE $sala \Leftarrow SALA\_INICIAL$
	\LOOP
		\STATE Visita sala atual //Zera o $t$ da sala atual na tabela
		\STATE $sala \Leftarrow$ sala\_de\_maior\_grau\_de\_urgência()
		\STATE Vai para $sala$
		\FORALL{vértice no caminho}
			\FORALL{Sala adjacente ao vértice}
				\STATE Vai para sala adjacente
				\STATE Visita a sala //Zera o $t$ da sala adjacente na tabela
				\STATE Volta para o vértice
			\ENDFOR
		\ENDFOR
	\ENDLOOP
\end{algorithmic}
\end{algorithm}

\begin{algorithm}
\caption{Algoritmo 3}
\label{alg:3}
\begin{algorithmic}[1]
	\STATE $sala \Leftarrow SALA\_INICIAL$
	\STATE $melhor\_fator \Leftarrow 0$
	\LOOP
		\STATE Visita a sala atual //Zera o $t$ da sala atual na tabela
		\FORALL{Sala $s$ da tabela $\neq sala$}
			\STATE $custo \Leftarrow$ custo\_sala(s) //Custo para chegar à sala $s$ da sala atual
			\STATE $fator \Leftarrow sala[s].U / custo$ //Divide o grau de urgência da sala pelo seu custo
			\IF{$fator > melhor\_fator$}
				\STATE $melhor\_fator \Leftarrow fator$
				\STATE $sala = s$
			\ENDIF
		\ENDFOR
		\STATE Vai para a sala com o melhor (maior) fator
	\ENDLOOP
\end{algorithmic}
\end{algorithm}

\subsection{Integração e Validação dos Algoritmos Implementados no Simulador Stage}
\label{integracao_e_validacao_algoritmos_stage}
Todos os três algoritmos (Algoritmo \ref{alg:1}, Algoritmo \ref{alg:2} e Algoritmo \ref{alg:3}) foram testados nos dois mapas (Figura \ref{fig:mapa_rep} e Figura \ref{fig:mapa_andar}). A freqüência de visitas e a trajetória dos algoritmos nos mapas são descritos e analisados na seção a seguir.

\section{Resultados Obtidos}
\label{resultados_obtidos}
Após vários testes e aperfeiçoamentos nas simulações como: O robô esperar 5 segundos para considerar que a sala foi visitada, simulando uma análise de dados qualquer; E a tolerância para o robô chegar em um vértice intermediário ser maior do que para chegar em um vértice-sala, o que faz com o que o robô não perca tempo chegando exatamente no ponto de um vértice intermediário, podendo ir para o vértice seguinte, otimizando a navegação. Foi realizada uma bateria de testes. Cada teste foi executado durante trinta minutos com atualização dos graus de urgência, para montar gráficos, de trinta segundos. A seguir, a trajetória do robô em cada teste, juntamente com uma tabela contendo freqüência absoluta das visitas e a quantidade de pontos e também um gráfico contendo a progressão do grau de urgência total do mapa, que é a soma dos graus de urgência das salas.

A Figura \ref{fig:rep_alg1} mostra a trajetória do robô no Mapa 1 utilizando o Algoritmo 1. Na Tabela \ref{tab:freq_pontos_1_1} estão as visitas em cada sala e o total de pontos adquiridos pelo Algoritmo 1 no Mapa 1. \figura{Imagens/rep_alg1_atu30_tot30.jpg}{.75}{Mapa 1 - Algoritmo 1.}{fig:rep_alg1}
\begin{table}
\begin{center}
	\begin{tabular}{|c|c|c|c|}
	\hline
	Sala & Prioridade & Visitas & Pontos\\
	\hline
	1 & 9 & 5 & 45\\
	\hline
	2 & 2 & 1 & 2\\
	\hline
	3 & 9 & 4 & 36\\
	\hline
	4 & 4 & 2 & 8\\
	\hline
	5 & 9 & 5 & 45\\
	\hline
	6 & 6 & 3 & 18\\
	\hline
	7 & 2 & 0 & 0\\
	\hline
	8 & 9 & 4 & 36\\
	\hline
	9 & 6 & 2 & 12\\
	\hline
	10 & 7 & 3 & 21\\
	\hline
	11 & 1 & 0 & 0\\
	\hline
	12 & 2 & 0 & 0\\
	\hline
	13 & 4 & 1 & 4\\
	\hline
	\multicolumn{3}{|c|}{\textbf{Total}} & \textbf{227}\\
	\hline
	\end{tabular}
\caption{Freqüência absoluta e pontos do Algoritmo 1 no Mapa 1.}
\label{tab:freq_pontos_1_1}
\end{center}
\end{table}
\newpage
A Figura \ref{fig:rep_alg2} mostra a trajetória do robô no Mapa 1 utilizando o Algoritmo 2. Na Tabela \ref{tab:freq_pontos_2_1} estão as visitas em cada sala e o total de pontos adquiridos pelo Algoritmo 2 no Mapa 1. \figura{Imagens/rep_alg2_atu30_tot30.jpg}{.75}{Mapa 1 - Algoritmo 2.}{fig:rep_alg2}
\begin{table}
\begin{center}
	\begin{tabular}{|c|c|c|c|}
	\hline
	Sala & Prioridade & Visitas & Pontos\\
	\hline
	1 & 9 & 5 & 45\\
	\hline
	2 & 2 & 1 & 2\\
	\hline
	3 & 9 & 10 & 90\\
	\hline
	4 & 4 & 1 & 4\\
	\hline
	5 & 9 & 4 & 36\\
	\hline
	6 & 6 & 11 & 66\\
	\hline
	7 & 2 & 0 & 0\\
	\hline
	8 & 9 & 3 & 27\\
	\hline
	9 & 6 & 15 & 90\\
	\hline
	10 & 7 & 3 & 21\\
	\hline
	11 & 1 & 0 & 0\\
	\hline
	12 & 2 & 0 & 0\\
	\hline
	13 & 4 & 1 & 4\\
	\hline
	\multicolumn{3}{|c|}{\textbf{Total}} & \textbf{385}\\
	\hline
	\end{tabular}
\caption{Freqüência absoluta e pontos do Algoritmo 2 no Mapa 1.}
\label{tab:freq_pontos_2_1}
\end{center}
\end{table}
\newpage
A Figura \ref{fig:rep_alg3} mostra a trajetória do robô no Mapa 1 utilizando o Algoritmo 3. Na Tabela \ref{tab:freq_pontos_3_1} estão as visitas em cada sala e o total de pontos adquiridos pelo Algoritmo 3 no Mapa 1. \figura{Imagens/rep_alg3_atu30_tot30.jpg}{.75}{Mapa 1 - Algoritmo 3.}{fig:rep_alg3}
\begin{table}
\begin{center}
	\begin{tabular}{|c|c|c|c|}
	\hline
	Sala & Prioridade & Visitas & Pontos\\
	\hline
	1 & 9 & 4 & 36\\
	\hline
	2 & 2 & 4 & 8\\
	\hline
	3 & 9 & 4 & 36\\
	\hline
	4 & 4 & 2 & 8\\
	\hline
	5 & 9 & 5 & 45\\
	\hline
	6 & 6 & 4 & 24\\
	\hline
	7 & 2 & 1 & 2\\
	\hline
	8 & 8 & 5 & 45\\
	\hline
	9 & 6 & 5 & 30\\
	\hline
	10 & 7 & 5 & 35\\
	\hline
	11 & 1 & 1 & 1\\
	\hline
	12 & 2 & 1 & 2\\
	\hline
	13 & 4 & 4 & 16\\
	\hline
	\multicolumn{3}{|c|}{\textbf{Total}} & \textbf{288}\\
	\hline
	\end{tabular}
\caption{Freqüência absoluta e pontos do Algoritmo 3 no Mapa 1.}
\label{tab:freq_pontos_3_1}
\end{center}
\end{table}

O Gráfico na Figura \ref{fig:grafico_rep_30m} demonstra a evolução do Grau de Urgência total no Mapa 1, comparando os três algoritmos.
\figura{Imagens/grafico_rep_30m.jpg}{.8}{Progressão do Grau de Urgência Total no Mapa 1}{fig:grafico_rep_30m}
\newpage
A Figura \ref{fig:andar_alg1} mostra a trajetória do robô no Mapa 2 utilizando o Algoritmo 1. Na Tabela \ref{tab:freq_pontos_1_2} estão as visitas em cada sala e o total de pontos adquiridos pelo Algoritmo 1 no Mapa 2. \figura{Imagens/andar_alg1_atu30_tot30.jpg}{.75}{Mapa 2 - Algoritmo 1.}{fig:andar_alg1}
\begin{table}
\begin{center}
	\begin{tabular}{|c|c|c|c|}
	\hline
	Sala & Prioridade & Visitas & Pontos\\
	\hline
	1 & 2 & 6 & 12\\
	\hline
	2 & 1 & 3 & 3\\
	\hline
	3 & 2 & 6 & 12\\
	\hline
	4 & 1 & 3 & 3\\
	\hline
	5 & 1 & 3 & 3\\
	\hline
	6 & 1 & 3 & 3\\
	\hline
	7 & 2 & 6 & 12\\
	\hline
	8 & 1 & 3 & 3\\
	\hline
	9 & 2 & 6 & 12\\
	\hline
	10 & 3 & 9 & 27\\
	\hline
	\multicolumn{3}{|c|}{\textbf{Total}} & \textbf{90}\\
	\hline
	\end{tabular}
\caption{Freqüência absoluta e pontos do Algoritmo 1 no Mapa 2.}
\label{tab:freq_pontos_1_2}
\end{center}
\end{table}
\newpage
A Figura \ref{fig:andar_alg2} mostra a trajetória do robô no Mapa 2 utilizando o Algoritmo 2. Na Tabela \ref{tab:freq_pontos_2_2} estão as visitas em cada sala e o total de pontos adquiridos pelo Algoritmo 2 no Mapa 2. \figura{Imagens/andar_alg2_atu30_tot30.jpg}{.75}{Mapa 2 - Algoritmo 2}{fig:andar_alg2}
\begin{table}
\begin{center}
	\begin{tabular}{|c|c|c|c|}
	\hline
	Sala & Prioridade & Visitas & Pontos\\
	\hline
	1 & 2 & 6 & 12\\
	\hline
	2 & 1 & 5 & 5\\
	\hline
	3 & 2 & 6 & 12\\
	\hline
	4 & 1 & 7 & 7\\
	\hline
	5 & 1 & 7 & 7\\
	\hline
	6 & 1 & 7 & 7\\
	\hline
	7 & 2 & 6 & 12\\
	\hline
	8 & 1 & 11 & 11\\
	\hline
	9 & 2 & 6 & 12\\
	\hline
	10 & 3 & 13 & 39\\
	\hline
	\multicolumn{3}{|c|}{\textbf{Total}} & \textbf{124}\\
	\hline
	\end{tabular}
\caption{Freqüência absoluta e pontos do Algoritmo 2 no Mapa 2.}
\label{tab:freq_pontos_2_2}
\end{center}
\end{table}
\newpage
A Figura \ref{fig:andar_alg2} mostra a trajetória do robô no Mapa 2 utilizando o Algoritmo 3. Na Tabela \ref{tab:freq_pontos_3_2} estão as visitas em cada sala e o total de pontos adquiridos pelo Algoritmo 3 no Mapa 2. \figura{Imagens/andar_alg3_atu30_tot30.jpg}{.75}{Mapa 2 - Algoritmo 3.}{fig:andar_alg3}
\begin{table}
\begin{center}
	\begin{tabular}{|c|c|c|c|}
	\hline
	Sala & Prioridade & Visitas & Pontos\\
	\hline
	1 & 2 & 7 & 14\\
	\hline
	2 & 1 & 5 & 5\\
	\hline
	3 & 2 & 8 & 16\\
	\hline
	4 & 1 & 5 & 5\\
	\hline
	5 & 1 & 4 & 4\\
	\hline
	6 & 1 & 4 & 4\\
	\hline
	7 & 2 & 8 & 16\\
	\hline
	8 & 1 & 5 & 5\\
	\hline
	9 & 2 & 7 & 14\\
	\hline
	10 & 3 & 13 & 36\\
	\hline
	\multicolumn{3}{|c|}{\textbf{Total}} & \textbf{122}\\
	\hline
	\end{tabular}
\caption{Freqüência absoluta e pontos do Algoritmo 3 no Mapa 2.}
\label{tab:freq_pontos_3_2}
\end{center}
\end{table}

O Gráfico na Figura \ref{fig:grafico_andar_30m} demonstra a evolução do Grau de Urgência total no Mapa 2, comparando os três algoritmos.
\figura{Imagens/grafico_andar_30m.jpg}{.8}{Progressão do Grau de Urgência Total no Mapa 2}{fig:grafico_andar_30m}

\section{Dificuldades e Limitações}
\label{dificuldades_e_limitacoes}
Das dificuldades encontradas, vale destacar a dificuldade de dar uma ordem para o robô que é simples do ponto de vista humano, como por exemplo no algoritmo 2 (Algoritmo \ref{alg:2}), no qual o robô visita salas adjacentes, no Mapa 1 (Figura \ref{fig:mapa_rep}), inicialmente a sala 1 era adjacente à sala 2 e compartilhavam um vértice em comum, isso gerou um problema, pois o robô antes de chegar à sala 1, visitava a sala 2, e assim que visitava a sala 1, ao querer sair da sala ele visitava novamente a sala 2. Para tentar resolver esse problema, foi colocada uma restrição de tempo, onde o robô só visitaria uma sala passado $x$ segundos, mas isso gerou um outro problema, pois o robô, deixava de visitar as salas adjacentes no início do algoritmo, que no início considera que todas as salas acabaram de serem visitadas. A melhor solução encontrada foi colocar um vértice na porta da sala 2, evitando assim que as salas 1 e 2 fossem adjacentes. 

Outra dificuldade, nesta mesma área, ocorreu durante o desenvolvimento de um algoritmo que simulava as visitas às salas em todos os caminhos possíveis da sala de origem à sala de destino, na simulação, quando o robô visitava uma sala, contava pontos. Esses pontos eram o Grau de Urgência da sala quando o robô chegava na mesma. Sendo assim, a trajetória com mais pontos seria a ideal, porém o robô gastava tempo desnecessariamente para chegar a uma sala, fazendo com que ganhasse mais pontos ao visita-la. Esse algoritmo foi descartado.